<!DOCTYPE html>
<html>
  <head>
    <title>Tornado WebSocket</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="/static/jquery.js"></script>
    <link href="/static/css/style.css" rel="stylesheet">
    <link href="/static/css/font-awesome-ie7.css" rel="stylesheet">
  </head>
  <body>
    <div id="container">
        <div id="chat" class="chatPanel normalPanel">
            <div class="content">
                <div id="chat_leftpanel" class="list">
                    <div class="top">
                        <div id="profile" class="title">
                           <div class="myProfile">
                                <img src="{{ avatar }}">
                                <div class="info">  <span class="nickName">{{ nickname }}</span> </div>
                                <div class="operaterBox" style="display:none;" id="operaterBox">
                                    <div class="operaterBoxPanel">  <a href="javascript:;" class="DesktopRemind" tip="Please enable desktop alert in your browser first."> <span class="iconPic iconPicDeskRem left"></span> <span class="operaterBoxTitle left">Desktop Alert</span> <div class="clr"></div> </a> <a href="javascript:;" class="voiceCancel" click="toggleMute"> <span class="iconPic  left"></span> <span class="operaterBoxTitle left">Sound Off</span> <div class="clr"></div> </a>     <a href="javascript:;" class="feedback" click="feedback">         <span class="iconPic iconFeedback left"></span>         <span class="operaterBoxTitle left">Feedback</span>         <div class="clr"></div>     </a>     <a href="javascript:;" class="iconLogout" url="/cgi-bin/mmwebwx-bin/webwxlogout" click="logout"> <span class="iconPic iconPicLogout left"></span>
                                    <span class="operaterBoxTitle left">Log Out</span> <div class="clr"></div> </a> </div>
                                </div>
                            </div>
                            <i class="icon-off"></i>
                       </div>
                    </div>
                    <div class="listContentWrap">
                        <div style="height: 400px; width: 100%; overflow-y: auto; overflow-x:hidden; position: relative;">
                            <div class="listContent">
                                <div class="conversationContainer">
                                    {% for client in clients %}
                                        <div class="chatListColumn">

                                            <div class="avatar_wrap"><img class="avatar" src="{{ client.avatar }}"></div>
                                            <div class="info">
                                                <div class="nickName">
                                                    <div class="left name" style="">{{ client.nickname }}</div>
                                                </div>
                                                <div class="descWrapper">
                                                    <p class="desc">{{ client.email }}</p>
                                                </div>
                                            </div>

                                        </div>
                                    {% end %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="vernierContainer" style="width: 32px; position: relative; float: left; overflow: hidden; margin-top: 135px; visibility: visible; height: 42px;">
                    <div class="activeChatVernier" style="top: -347.5px;"></div>
                </div>
                <div class="chat lightBorder" style="visibility: visible;height:400px">
                    <div class="chatContainer">
                        <div class="chatTitle"></div>
                        <div class="chatScorll" id="message"></div>
                        <div id="chat_editor" class="chatOperator lightBorder">
                            <div class="inputArea">
                                <form id="subform">
                                    <a id="btnSend" href="#" class="chatSend"><b>发送</b></a>
                                    <textarea type="text" id="textInput" class="chatInput lightBorder"></textarea>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/template" id="tpl_chatItem">
        <div class='chatItem {2}'>
            <div>
                <img class='avatar' src='{1}' title='{3}'/>
                <div class='content'>{0}</div>
                <div style='clear:both'></div>
            </div>
        </div>
    </script>

    <script type="text/javascript">

        var current_user = '{{ email }}'

        //Template

        var tpl_chatItem = $("#tpl_chatItem").html();

        $(function(){

            $('#subform').submit(function(event){
                var value = $('#textInput').val();
                $.post("./chat", { data: value }, function(data){
                    $("#data").val('');
                });
                $('#textInput').val("");
                return false;
            });

            $("#btnSend").click(function(){
                $('#subform').submit()
                return false
            });

            if ("WebSocket" in window) {

                var ws = new WebSocket('ws://localhost:8888/websocket')

                ws.onmessage = function(event){

                    obj = eval("("+event.data+")")
                    console.log(obj)
                    var tpl = tpl_chatItem.replace("{0}", obj.message)
                        .replace("{1}", obj.avatar)
                        .replace("{3}", obj.nickname)

                    if(obj.email==current_user){
                        tpl = tpl.replace("{2}", "me")
                    }else{
                        tpl = tpl.replace("{2}", "you")
                    }

                    $("#message").append(tpl)
                }

            } else {

              alert("WebSocket not supported");

            }



        });
    </script>
  </body>
</html>
